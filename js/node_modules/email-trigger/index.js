var inbox = require("inbox");
var MailParser = require("mailparser").MailParser;

module.exports = function(config, callback) {

  var client = inbox.createConnection(false, config.host, {
    secureConnection: true,
    auth: {
      user: config.user,
      pass: config.pass
    }
  });

  client.on("connect", function() {
    client.openMailbox("INBOX", function(error, info) {
      console.log("connected to server");
    });
  });

  client.on("new", function(message) {
    client.createMessageStream(message.UID).pipe(new MailParser().on("end", function(mail) {
      callback(mail);
    }));
  });

  client.connect();

};
